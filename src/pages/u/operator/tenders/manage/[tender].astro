---
import OperatorLayout from "../../../../../layouts/OperatorLayout.astro";
import { prisma } from "@/utilities/helpers/prismaInstace";
import { ManageTenderComponent } from "@/components/ui/react/manage-tender-component";
import { Headers } from "@/constants";

const { tender } = Astro.params;
//@ts-ignore
const res = await fetch(
  `${process.env.API_ENDPOINT}/v1/tenders/manage-tender/?${new URLSearchParams({ tender }).toString()}`, {headers: Headers}
);
const data = await res.json();
const token = Headers["x-pol-rfx-secret"];

const listRecipients = async () => {
  const recipients = await Promise.all(
    data?.tender?.recipients.map(async (item) => {
      const response = await prisma.contractor.findFirst({
        where: { id: item?.contractorId },
      });
      return response;
    })
  );
  return recipients;
};

const receivers = await listRecipients();
const result = Object.assign({ ...data, recipientsWithDetails: receivers });
---

<OperatorLayout title={`Tender | ${result?.tender?.title}`}>
  <ManageTenderComponent token={token} client:load result={result} />
</OperatorLayout>
